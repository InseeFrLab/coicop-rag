import os
from openai import OpenAI

client_llm = OpenAI(
    api_key=os.environ["OLLAMA_API_KEY"],
    base_url=os.environ["OLLAMA_URL"]
)

texts = ['thermometre aquarium', 'billeterie', '4 baguettes', 'diverses courses']
response = client_llm.embeddings.create(
    model='qwen3-embedding:8b',
    input=texts
)
len(response.data) # = 1



messages = [[{'role': 'system', 'content': "Tu es un expert de la **COICOP (Classification of Individual Consumption According to Purpose)** chargé de classifier automatiquement l'activité principale d'une entreprise à partir de la description textuelle de son activité.\nTa tâche est de **classifier** des produits selon la nomenclature COICOP, en utilisant **uniquement** les descriptions des items proposés ci-dessous."}, {'role': 'user', 'content': '# Produit à coder :\nthermometre aquarium\n\n\n\n# Liste des codes APE potentiels et leurs notes explicatives :\n[\'**01.2.9.0.1: Eau aromatisée**\\n\\n**Inclusions:** — eau aromatisée\', "**06.1.2.1.1: Produits de diagnostic médical**\\n\\n**Inclusions:** — matériel de diagnostic destiné à l\'autocontrôle et pour un usage personnel en dehors d\'un établissement de santé ou d\'une institution\\n— tests de grossess\\xa0; thermomètres, glucomètres, tensiomètres et autres dispositifs utilisés pour les tests au point d\'intervention\\xa0; pèse-bébés, etc.. — produits de diagnostics médicaux achetés par internet pour un usage personnel\\n\\n**Exclusions:** — produits de diagnostic destinés à être utilisés dans un établissement ou une institution de santé (06.2, 06.3)\\n— balances (13.1.2.0)", "**06.1.2.1: Produits de diagnostic médical (ND)**\\n\\n**Inclusions:** — matériel de diagnostic destiné à l\'autocontrôle et pour un usage personnel en dehors d\'un établissement de santé ou d\'une institution\\n— tests de grossess\\xa0; thermomètres, glucomètres, tensiomètres et autres dispositifs utilisés pour les tests au point d\'intervention\\xa0; pèse-bébés, etc.. — produits de diagnostics médicaux achetés par internet pour un usage personnel\\n\\n**Exclusions:** — produits de diagnostic destinés à être utilisés dans un établissement ou une institution de santé (06.2, 06.3)\\n— balances (13.1.2.0)", \'**01.2.3.0.2: Thé glacé**\\n\\n**Inclusions:** — thé glacé\', "**09.1.1.2.1: Accessoires pour matériel photographique et cinématographique**\\n\\n**Inclusions:** — pièces et accessoires pour équipements photographiques et cinématographiques et instruments optiques tels que les écrans, les visionneuses, les objectifs (y compris les zooms), les flashes, les filtres, les posemètres, etc.\\n— révélateurs photographiques et papier photographique. — matériels achetés par les ménages dans l\'intention d\'effectuer eux-mêmes l’entretien et le réparation\\n— films photographiques et cinématographiques vierges\\n— batteries et chargeurs pour appareils photographiques"]\n\n========\n\n# Instructions:\n1. Utilise **seulement** la liste des codes COICOP proposés pour réaliser la classification. **Aucun code externe n’est autorisé**.\n2. Si plusieurs produits différents sont mentionnés, **prends uniquement le premier** pour déterminer le code.\n3. Essaye de choisir le code le plus détaillé, au niveau le plus fin de la nomenclature,  si tu as suffisament d\'information pour cela.\n3. Si la description n’est **pas suffisamment claire**, indique `"coicop": null` et `"codable": false`.\n4. Sélectionne obligatoirement le code COICOP à partir de cette liste uniquement : [[\'01.2.9.0.1\', \'06.1.2.1.1\', \'06.1.2.1\', \'01.2.3.0.2\', \'09.1.1.2.1\']]\n5. Fournis un score de confiance réaliste (\'confidence\'), format 0.00, compris entre 0 (faible) et 1 (élevé).\n6. Pour un même nom de produit, le code n\'est pas le même s\'il est acheté en supermarché ou consommé dans un bar/restaurant (par exemple "café", "nourriture", "coca"). S\'il y a ambiguïté, mets une confidence faible.\n6. Résumé de façon très courte ton raisonnement (\'reasons\').\n7. **Ta réponse doit être uniquement un objet JSON** conforme au schéma suivant : **Aucune explication, justification ou texte supplémentaire ne doit être généré en dehors du json.**\n\n```json\n{\n  "codable": <bool>,\n  "coicop_pred": <code APE ou null>,\n  "confidence": <float, deux décimales max>,\n  "reasons": <string, texte court>\n}\n```'}], [{'role': 'system', 'content': "Tu es un expert de la **COICOP (Classification of Individual Consumption According to Purpose)** chargé de classifier automatiquement l'activité principale d'une entreprise à partir de la description textuelle de son activité.\nTa tâche est de **classifier** des produits selon la nomenclature COICOP, en utilisant **uniquement** les descriptions des items proposés ci-dessous."}, {'role': 'user', 'content': '# Produit à coder :\nbilleterie\n\n# Pour information, ce produit a été acheté dans cette enseigne : FC METZ\n\n# Liste des codes APE potentiels et leurs notes explicatives :\n["**09.6.1: Services fournis par les cinémas, les théâtres et les salles de concert (S)**\\n\\n**Inclusions:** — services fournis par les cinémas\\n— services fournis par les théâtres et opéras\\n— services fournis par les salles de concert et de musique\\n— services fournis par les cirques, sons et lumières et autres spectacles. — services de musiciens, de clowns, d\'artistes pour des divertissements privés\\n— musique, danse et performances artistiques\\n— festivals d\'art et de musique", "**09.6.1.0: Services fournis par les cinémas, les théâtres et les salles de concert (S)**\\n\\n**Inclusions:** — services fournis par les cinémas\\n— services fournis par les théâtres et opéras\\n— services fournis par les salles de concert et de musique\\n— services fournis par les cirques, sons et lumières et autres spectacles. — services de musiciens, de clowns, d\'artistes pour des divertissements privés\\n— musique, danse et performances artistiques\\n— festivals d\'art et de musique", \'**09.4.6.3: Services liés à la fréquentation de manifestations sportives (S)**\\n\\n**Inclusions:** — billets d’entrée pour des événements sportifs en direct, tels que matchs de football, matchs de hockey, compétitions de patinage sur glace, compétitions de ski, matchs de football, matchs de tennis, courses de chevaux, circuits de course automobile, courses de vélos (dans des vélodromes), etc.\', \'**09.4.6.3.1: Services liés à la fréquentation de manifestations sportives**\\n\\n**Inclusions:** — billets d’entrée pour des événements sportifs en direct, tels que matchs de football, matchs de hockey, compétitions de patinage sur glace, compétitions de ski, matchs de football, matchs de tennis, courses de chevaux, circuits de course automobile, courses de vélos (dans des vélodromes), etc.\', "**09.6.1.0.2: Spectacles vivants**\\n\\n**Inclusions:** — services fournis par les théâtres et opéras\\n— services fournis par les salles de concert et de musique\\n— services fournis par les cirques, sons et lumières et autres spectacles. — services de musiciens, de clowns, d\'artistes pour des divertissements privés\\n— musique, danse et performances artistiques\\n— festivals d\'art et de musique"]\n\n========\n\n# Instructions:\n1. Utilise **seulement** la liste des codes COICOP proposés pour réaliser la classification. **Aucun code externe n’est autorisé**.\n2. Si plusieurs produits différents sont mentionnés, **prends uniquement le premier** pour déterminer le code.\n3. Essaye de choisir le code le plus détaillé, au niveau le plus fin de la nomenclature,  si tu as suffisament d\'information pour cela.\n3. Si la description n’est **pas suffisamment claire**, indique `"coicop": null` et `"codable": false`.\n4. Sélectionne obligatoirement le code COICOP à partir de cette liste uniquement : [[\'09.6.1\', \'09.6.1.0\', \'09.4.6.3\', \'09.4.6.3.1\', \'09.6.1.0.2\']]\n5. Fournis un score de confiance réaliste (\'confidence\'), format 0.00, compris entre 0 (faible) et 1 (élevé).\n6. Pour un même nom de produit, le code n\'est pas le même s\'il est acheté en supermarché ou consommé dans un bar/restaurant (par exemple "café", "nourriture", "coca"). S\'il y a ambiguïté, mets une confidence faible.\n6. Résumé de façon très courte ton raisonnement (\'reasons\').\n7. **Ta réponse doit être uniquement un objet JSON** conforme au schéma suivant : **Aucune explication, justification ou texte supplémentaire ne doit être généré en dehors du json.**\n\n```json\n{\n  "codable": <bool>,\n  "coicop_pred": <code APE ou null>,\n  "confidence": <float, deux décimales max>,\n  "reasons": <string, texte court>\n}\n```'}]]

len(messages) # 2 
res = client_llm.chat.completions.create(
    model='gpt-oss:20b',
    messages=messages,
    temperature=0.1,
    max_tokens=256,
    response_format={"type": "json_object"}
)

res.choices[0].message.content